<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Exercise 16 - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" >
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Welcome to MkDocs</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Exercises</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Ex13/" class="dropdown-item">Exercise 13</a>
</li>
                                    
<li>
    <a href="../Ex14/" class="dropdown-item">Exercise 14</a>
</li>
                                    
<li>
    <a href="../Ex15/" class="dropdown-item">Exercise 15</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Exercise 16</a>
</li>
                                    
<li>
    <a href="../Ex17/" class="dropdown-item">Exercise 17</a>
</li>
                                    
<li>
    <a href="../Ex18/" class="dropdown-item">Exercise 18</a>
</li>
                                    
<li>
    <a href="../Ex19/" class="dropdown-item">Exercise 19</a>
</li>
                                    
<li>
    <a href="../Ex20/" class="dropdown-item">Exercise 20</a>
</li>
                                    
<li>
    <a href="../Ex28/" class="dropdown-item">Exercise 28</a>
</li>
                                    
<li>
    <a href="../Ex29/" class="dropdown-item">Exercise 28</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Test</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../test/test/" class="dropdown-item">Test</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Glossar</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../glossar/glos/" class="dropdown-item">Glos</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Ex15/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Ex17/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="true">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#exercise-16" class="nav-link">Exercise 16</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#goal" class="nav-link">Goal</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#steps" class="nav-link">Steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#result" class="nav-link">Result</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="exercise-16">Exercise 16</h1>
<h2 id="goal">Goal</h2>
<p>Since the public and private ssh key of the server is created by the terraform script it is possible to add the pubilc key to a "known_hosts" file. </p>
<p>Consequently ssh does not have to accept any unkown public key fingerprints and ensures we are connected to the right server.</p>
<p>This makes the ssh connection a bit more secure but also little inconvenient because the "known_hosts" file has to be manually linked when executing the ssh command.</p>
<p>To fix this terraform can create a bash script with the ssh command to the correct "known_hosts" file, username and host.</p>
<p>Because this more practical and secure it should also create a bash script to copy files to the server with "scp".</p>
<h2 id="steps">Steps</h2>
<h3 id="1-create-bash-file-in-template-directory">1. Create bash file in template directory</h3>
<ul>
<li>Has to begin with:</li>
</ul>
<pre><code class="language-bash">#!/usr/bin/env bash
</code></pre>
<h3 id="2-write-ssh-command-that-uses-the-generated-known_host-file">2. Write ssh command that uses the generated known_host file</h3>
<pre><code class="language-bash">GEN_DIR=$(dirname &quot;$0&quot;)/../gen

ssh -o UserKnownHostsFile=&quot;$GEN_DIR/known_hosts&quot; user@host &quot;$@&quot;
</code></pre>
<ul>
<li>The variable <strong>GEN_DIR</strong> always points to the directory <strong>gen</strong> where the <strong>known_hosts</strong> file is located since the scripts are always in the <strong>bin</strong> directory that is located right next to the <strong>gen</strong> directory</li>
<li>The option <strong>-o UserKnownHostsFile</strong> is used to set a custom <strong>known_hosts</strong> for the ssh connection</li>
<li><strong>$@</strong> appends any option that is set when executing the script to the ssh command</li>
</ul>
<h3 id="3-add-placeholder-variables-for-the-terraform-template">3. Add placeholder variables for the terraform template</h3>
<pre><code class="language-bash">ssh (...) ${devopsUsername}@${ip}
</code></pre>
<ul>
<li>The variable <strong>devopsUsername</strong> and <strong>ip</strong> can be set by terraform when generating the script based of the template </li>
</ul>
<h3 id="4-let-terraform-generated-the-script-based-of-the-template">4. Let terraform generated the script based of the template</h3>
<pre><code>resource &quot;local_file&quot; &quot;ssh_script&quot; {
    content = templatefile(&quot;{path.module}/template/ssh-template.sh&quot;, {
        devopsUsername = var.devopsUsername,
        ip = hcloud_server.mainServer.ipv4_address
        })
    filename = &quot;../bin/ssh.sh&quot;
}
</code></pre>
<ul>
<li>The right resource type for this is <strong>local_file</strong> which offers two important attributes: <ul>
<li><strong>content</strong> contains the text that should be written in the file. </li>
<li><strong>filename</strong> contains the path to the directory where the file should be saved aswell as the filename with extension.</li>
</ul>
</li>
<li>The <strong>templatefile()</strong> function reads the content of the template file and replaces the given keywords (<strong>devopsUsername</strong> and <strong>ip</strong>) with the assosiated values (<strong>var.devopsUsername</strong> and <strong>hcloud_server.mainServer.ipv4_address</strong>)</li>
</ul>
<p>### 4. Execute the generated script with bash
 - The generated file may look like this and can be executed in the terminal like this: <strong>bash ./ssh.sh</strong></p>
<pre><code class="language-bash">#!/usr/bin/env bash

GEN_DIR=$(dirname &quot;$0&quot;)/../gen

ssh -o UserKnownHostsFile=&quot;$GEN_DIR/known_hosts&quot; devops@77.42.37.25 &quot;$@&quot;
</code></pre>
<h3 id="5-repeat-everything-with-scp">5. Repeat everything with scp</h3>
<pre><code class="language-bash">#!/usr/bin/env bash

GEN_DIR=$(dirname &quot;$0&quot;)/../gen

if [ $# -lt 2 ]; then
   echo usage: .../bin/scp ... devops@157.180.78.16 ...
else
   scp -o UserKnownHostsFile=&quot;$GEN_DIR/known_hosts&quot; $1 ${devopsUsername}@${ip}:$2
fi
</code></pre>
<ul>
<li>The scp script is structured very similar, but since it requires additional user arguments for the path of the source and destination the script checks that at least two arguments are given</li>
<li>This would be an example usage of the scp script that copies a ssh public key to the server</li>
</ul>
<pre><code>bash ./scp.sh ~/.ssh/id_ed25519.pub ~/.ssh/id_ed25519.pub
</code></pre>
<h2 id="result">Result</h2>
<ul>
<li><a href="https://gitlab.mi.hdm-stuttgart.de/jb321/infra-tastic/-/tree/main/exercises/ex16">files</a></li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
